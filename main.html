<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bet Builder</title>
    <style>
        body {
            font-family: Arial, sans-serif;
        }
        #balance {
            font-weight: bold;
            color: green;
        }
    </style>
</head>
<body>
    <h1>Bet Builder Project</h1>
    <p>Your current balance: <span id="balance">$100,000</span></p>

    <form action="/submit-bet" method="post">
        <fieldset>
            <legend>Place Your Bet</legend>
            <div>
                <input type="checkbox" id="whiteboard" name="event" value="whiteboard">
                <label for="whiteboard">Turning off the whiteboard</label>
                <input type="number" id="whiteboardCount" name="whiteboardCount" min="0" placeholder="Times">
            </div>

            <div>
                <input type="checkbox" id="classroom" name="event" value="classroom">
                <label for="classroom">Threatening to be kicked out of the classroom</label>
                <input type="number" id="classroomCount" name="classroomCount" min="0" placeholder="Times">
            </div>
             
            <div>
                <input type="checkbox" id="talk" name="event" value="talk">
                <label for="talk">Talk to V=UAT</label>
                <input type="number" id="talkCount" name="talkCount" min="0" placeholder="Times">
            </div>

            <br>
            <label for="betAmount">Stake Amount:</label>
            <input type="number" id="betAmount" name="betAmount" min="1" placeholder="Enter stake amount">

            <p>Odds:</p>
            <ul>
                <li>Turning off the monitors: 9/8</li>
                <li>Threatening to be kicked out of the classroom: 3/2</li>
                <li>Talk to AT: 100/99</li>
            </ul>

            <br>
            <input type="submit" value="Place Bet">
            <p id="totalWinnings">Total Potential Winnings: $0.00</p>
        </fieldset>
    </form>

    <script>
        // Event listeners for calculating winnings
        document.getElementById("whiteboardCount").addEventListener("input", calculateWinnings);
        document.getElementById("classroomCount").addEventListener("input", calculateWinnings);
        document.getElementById("talkCount").addEventListener("input", calculateWinnings);
        document.getElementById("betAmount").addEventListener("input", calculateWinnings);

        // Function to calculate potential winnings
        function calculateWinnings() {
            const monitorsCount = parseInt(document.getElementById("whiteboardCount").value) || 0;
            const classroomCount = parseInt(document.getElementById("classroomCount").value) || 0;
            const talkCount = parseInt(document.getElementById("talkCount").value) || 0;
            const betAmount = parseFloat(document.getElementById("betAmount").value) || 0;

            const MonitorOdds = 9 / 8;
            const classroomOdds = 3 / 2;
            const talkOdds = 100 / 99;

            const combinedOdds = adjustedOdds(MonitorOdds, monitorsCount) * 
                                 adjustedOdds(classroomOdds, classroomCount) * 
                                 adjustedOdds(talkOdds, talkCount);

            const totalWinnings = betAmount * combinedOdds;
            document.getElementById("totalWinnings").textContent = `Total Potential Winnings: $${totalWinnings.toFixed(2)}`;
        }

        // Function to adjust odds based on count
        function adjustedOdds(odds, count) {
            return Math.pow(odds, count);
        }
      </script>
  
      <script type="module">
            
              // Import the functions you need from the SDKs you need
              // Import the functions you need from the SDKs you need
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-app.js";
import { getFirestore, collection, doc, setDoc, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-firestore.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-auth.js";
import { runTransaction } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-firestore.js";
          
// The runTransaction function is part of Firestore and does not need to be imported separately

// Your web app's Firebase configuration
const firebaseConfig = {
  apiKey: "AIzaSyASccDZI88CsOteCtjaeIgR3XNYiotV01I",
  authDomain: "gamblingproject-531a2.firebaseapp.com",
  projectId: "gamblingproject-531a2",
  storageBucket: "gamblingproject-531a2.appspot.com",
  messagingSenderId: "979010319245",
  appId: "1:979010319245:web:c79d1d04abe721b5df03c4",
  measurementId: "G-Q26C1LE2Q7"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);




        // Function to create a new user with an initial balance
        async function signUp(email, password) {
    try {
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        console.log('User signed up with UID:', userCredential.user.uid); // Log the user's UID

        const userDocRef = doc(db, 'users', userCredential.user.uid);
        console.log('Attempting to create user document with initial balance...'); // Log the attempt to create the document

        await setDoc(userDocRef, {
            balance: 100000 // Set the initial balance to 100,000
        });
        console.log('User document created with initial balance.'); // Log the successful creation of the document

        alert('Account created successfully with $100,000 balance!');
    } catch (error) {
        console.error('Error creating account:', error); // Log any errors that occur
        alert('Error creating account: ' + error.message);
    }
}




        // Function to log in and retrieve the user's balance
        async function login(email, password) {
            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                const userDoc = await getDoc(doc(db, 'users', userCredential.user.uid));
                if (userDoc.exists()) {
                    document.getElementById('balance').textContent = `$${userDoc.data().balance}`;
                    alert('Login successful!');
                } else {
                    console.log("No such document!");
                }
            } catch (error) {
                alert('Invalid username or password!');
            }
        }

        // Function to place a bet and update the user's balance
       // Function to place a bet and update the user's balance
async function placeBet(betAmount) {
    console.log('Attempting to place a bet...'); // Log attempt to place a bet

    const userId = auth.currentUser ? auth.currentUser.uid : null; // Get the current user's ID
    console.log('Current User ID:', userId); // Log the current user's ID

    if (!userId) {
        console.error('No user logged in. Cannot place a bet.');
        return;
    }

    // Reference to the user's document
    const userRef = doc(db, 'users', userId);
    console.log('User document reference:', userRef); // Log the user document reference

    try {
        console.log('Starting transaction...'); // Log the start of the transaction
        await runTransaction(db, async (transaction) => {
            console.log('Inside transaction...'); // Log inside the transaction

            const userDoc = await transaction.get(userRef);
            console.log('Retrieved user document:', userDoc.exists()); // Log if the user document exists

            if (!userDoc.exists()) {
                throw new Error("User does not exist!");
            }

            const userData = userDoc.data();
            console.log('Current balance:', userData.balance); // Log the current balance

            if (userData.balance < betAmount) {
                throw new Error("Insufficient funds!");
            }

            // Deduct the bet amount from the user's balance
            const newBalance = userData.balance - betAmount;
            console.log('New balance after bet:', newBalance); // Log the new balance

            // Update the user's balance in the transaction
            transaction.update(userRef, { balance: newBalance });
            console.log('Updated user balance in transaction.'); // Log the balance update
        });
        console.log('Transaction completed successfully.'); // Log the successful completion of the transaction
    } catch (error) {
        console.error('Failed to place bet:', error); // Log any errors encountered
    }
}



        // Add this function call to your form's submit event
        document.querySelector('form').addEventListener('submit', function(event) {
            event.preventDefault(); // Prevent the default form submission
            const betAmount = parseFloat(document.getElementById('betAmount').value) || 0;
            placeBet(betAmount);
        });
     </script>
</head>
<body>
      </html>
