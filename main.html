<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bet Builder</title>
    <style>
        body {
            font-family: Arial, sans-serif;
        }
        #balance {
            font-weight: bold;
            color: green;
        }
    </style>
</head>
<body>
    <h1>Bet Builder Project</h1>
    <p>Your current balance: <span id="balance">$100,000</span></p>

    <form action="/submit-bet" method="post">
        <fieldset>
            <legend>Place Your Bet</legend>
            <div>
                <input type="checkbox" id="whiteboard" name="event" value="whiteboard">
                <label for="whiteboard">Turning off the whiteboard</label>
                <input type="number" id="whiteboardCount" name="whiteboardCount" min="0" placeholder="Times">
            </div>

            <div>
                <input type="checkbox" id="classroom" name="event" value="classroom">
                <label for="classroom">Threatening to be kicked out of the classroom</label>
                <input type="number" id="classroomCount" name="classroomCount" min="0" placeholder="Times">
            </div>
             
            <div>
                <input type="checkbox" id="talk" name="event" value="talk">
                <label for="talk">Talk to V=UAT</label>
                <input type="number" id="talkCount" name="talkCount" min="0" placeholder="Times">
            </div>

            <div id="betsContainer"></div>


            <br>
            <label for="betAmount">Stake Amount:</label>
            <input type="number" id="betAmount" name="betAmount" min="1" placeholder="Enter stake amount">

            <p>Odds:</p>
            <ul>
                <li>Turning off the monitors: 9/8</li>
                <li>Threatening to be kicked out of the classroom: 3/2</li>
                <li>Talk to AT: 100/99</li>
            </ul>

            <br>
            <input type="submit" value="Place Bet">
            <p id="totalWinnings">Total Potential Winnings: $0.00</p>
        </fieldset>
            
    </form>

    <script>
        // Event listeners for calculating winnings
        document.getElementById("whiteboardCount").addEventListener("input", calculateWinnings);
        document.getElementById("classroomCount").addEventListener("input", calculateWinnings);
        document.getElementById("talkCount").addEventListener("input", calculateWinnings);
        document.getElementById("betAmount").addEventListener("input", calculateWinnings);


        function gcd(a, b) {
    if (!b) {
        return a;
    }
    return gcd(b, a % b);
}


        // Function to calculate potential winnings
        function calculateWinnings() {
            const monitorsCount = parseInt(document.getElementById("whiteboardCount").value) || 0;
            const classroomCount = parseInt(document.getElementById("classroomCount").value) || 0;
            const talkCount = parseInt(document.getElementById("talkCount").value) || 0;
            const betAmount = parseFloat(document.getElementById("betAmount").value) || 0;

            const MonitorOdds = 9 / 8;
            const classroomOdds = 3 / 2;
            const talkOdds = 100 / 99;

            const combinedOdds = adjustedOdds(MonitorOdds, monitorsCount) * 
                                 adjustedOdds(classroomOdds, classroomCount) * 
                                 adjustedOdds(talkOdds, talkCount);

            const totalWinnings = betAmount * combinedOdds;
            document.getElementById("totalWinnings").textContent = `Total Potential Winnings: $${totalWinnings.toFixed(2)}`;
        }

        // Function to adjust odds based on count
        function adjustedOdds(odds, count) {
            return Math.pow(odds, count);
        }
      </script>
  
      <script type="module">

       document.querySelector('form').addEventListener('submit', function(event) {
    event.preventDefault(); // Prevent the default form submission

    // Get the bet details
    const betAmount = parseFloat(document.getElementById('betAmount').value) || 0;
    const whiteboardChecked = document.getElementById('whiteboard').checked;
    const classroomChecked = document.getElementById('classroom').checked;
    const talkChecked = document.getElementById('talk').checked;
    const whiteboardCount = parseInt(document.getElementById('whiteboardCount').value) || 0;
    const classroomCount = parseInt(document.getElementById('classroomCount').value) || 0;
    const talkCount = parseInt(document.getElementById('talkCount').value) || 0;

    // Calculate combined odds and format them
    let combinedOddsNumerator = 1;
    let combinedOddsDenominator = 1;
    if (whiteboardChecked) {
        combinedOddsNumerator *= Math.pow(9, whiteboardCount);
        combinedOddsDenominator *= Math.pow(8, whiteboardCount);
    }
    if (classroomChecked) {
        combinedOddsNumerator *= Math.pow(3, classroomCount);
        combinedOddsDenominator *= Math.pow(2, classroomCount);
    }
    if (talkChecked) {
        combinedOddsNumerator *= Math.pow(100, talkCount);
        combinedOddsDenominator *= Math.pow(99, talkCount);
    }

    // Simplify the odds
    const divisor = gcd(combinedOddsNumerator, combinedOddsDenominator);
    combinedOddsNumerator /= divisor;
    combinedOddsDenominator /= divisor;

    // Construct the bet details string
    // Construct the bet details string
const bets = [];
if (whiteboardChecked && whiteboardCount > 0) {
    bets.push(`Bet on Whiteboard: ${whiteboardCount}X`);
}
if (classroomChecked && classroomCount > 0) {
    bets.push(`Bet on Classroom: ${classroomCount}X`);
}
if (talkChecked && talkCount > 0) {
    bets.push(`Bet on Talk: ${talkCount}X`);
}
const betDetailsText = `Placed bets: ${bets.join(', ')}; Stake: $${betAmount}; Odds: ${combinedOddsNumerator}/${combinedOddsDenominator}`;

// Display the bet details
const betsContainer = document.getElementById('betsContainer');
betsContainer.innerHTML = ''; // Clear previous bets
const betDetail = document.createElement('p');
betDetail.textContent = betDetailsText;
betsContainer.appendChild(betDetail);


    // Place the bet (your existing function)
    placeBet(betAmount);
});

            
              // Import the functions you need from the SDKs you need
              // Import the functions you need from the SDKs you need
// Import the functions you need from the SDKs you need
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-app.js";
import { getFirestore, doc, setDoc, getDoc, runTransaction } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-firestore.js";
import { getAuth, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-auth.js";
          import { onSnapshot } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-firestore.js";


          
// The runTransaction function is part of Firestore and does not need to be imported separately

// Your web app's Firebase configuration
const firebaseConfig = {
  apiKey: "AIzaSyASccDZI88CsOteCtjaeIgR3XNYiotV01I",
  authDomain: "gamblingproject-531a2.firebaseapp.com",
  projectId: "gamblingproject-531a2",
  storageBucket: "gamblingproject-531a2.appspot.com",
  messagingSenderId: "979010319245",
  appId: "1:979010319245:web:c79d1d04abe721b5df03c4",
  measurementId: "G-Q26C1LE2Q7"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);


       // Function to place a bet and update the user's balance
async function placeBet(betAmount) {
    console.log('Attempting to place a bet...'); // Log attempt to place a bet

    const userId = auth.currentUser ? auth.currentUser.uid : null; // Get the current user's ID
    console.log('Current User ID:', userId); // Log the current user's ID

    if (!userId) {
        console.error('No user logged in. Cannot place a bet.');
        return;
    }

    // Reference to the user's document
    const userRef = doc(db, 'users', userId);
    console.log('User document reference:', userRef); // Log the user document reference

    try {
        console.log('Starting transaction...'); // Log the start of the transaction
        await runTransaction(db, async (transaction) => {
            console.log('Inside transaction...'); // Log inside the transaction

            const userDoc = await transaction.get(userRef);
            console.log('Retrieved user document:', userDoc.exists()); // Log if the user document exists

            if (!userDoc.exists()) {
                throw new Error("User does not exist!");
            }

            const userData = userDoc.data();
            console.log('Current balance:', userData.balance); // Log the current balance

            if (userData.balance < betAmount) {
                throw new Error("Insufficient funds!");
            }

            // Deduct the bet amount from the user's balance
            const newBalance = userData.balance - betAmount;
            console.log('New balance after bet:', newBalance); // Log the new balance

            // Update the user's balance in the transaction
            transaction.update(userRef, { balance: newBalance });
            console.log('Updated user balance in transaction.'); // Log the balance update
        });
        console.log('Transaction completed successfully.'); // Log the successful completion of the transaction
    } catch (error) {
        console.error('Failed to place bet:', error); // Log any errors encountered
    }
}
          auth.onAuthStateChanged((user) => {
  if (user) {
    // User is signed in, call the function to display and update the balance
    displayAndUpdateBalance();
  } else {
    // User is signed out, handle it appropriately
    console.log('User is not logged in.');
  }
});


          
          function displayAndUpdateBalance() {
  const user = auth.currentUser;
  if (user) {
    const userRef = doc(db, 'users', user.uid);
    
    // Listen for real-time updates to the user's document
    onSnapshot(userRef, (doc) => {
      const userData = doc.data();
      if (userData && userData.balance !== undefined) {
        // Update the balance displayed in the <span> element
        document.getElementById('balance').textContent = `$${userData.balance.toFixed(2)}`;
      }
    }, (error) => {
      // Handle any errors that occur
      console.error("Error fetching user data:", error);
    });
  }
}



        // Add this function call to your form's submit event
        document.querySelector('form').addEventListener('submit', function(event) {
            event.preventDefault(); // Prevent the default form submission
            const betAmount = parseFloat(document.getElementById('betAmount').value) || 0;
            placeBet(betAmount);
        });
     </script>
</head>
<body>
      </html>
