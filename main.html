<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bet Builder</title>
    <style>
        body {
            font-family: Arial, sans-serif;
        }
        #balance {
            font-weight: bold;
            color: green;
        }
    </style>
</head>
<body>
    <h1>Bet Builder Project</h1>
    <p>Your current balance: <span id="balance">$100,000</span></p>

    <form action="/submit-bet" method="post">
        <fieldset>
            <legend>Place Your Bet</legend>
            <div>
                <input type="checkbox" id="whiteboard" name="event" value="whiteboard">
                <label for="whiteboard">Turning off the whiteboard</label>
                <input type="number" id="whiteboardCount" name="whiteboardCount" min="0" placeholder="Times">
            </div>

            <div>
                <input type="checkbox" id="classroom" name="event" value="classroom">
                <label for="classroom">Threatening to be kicked out of the classroom</label>
                <input type="number" id="classroomCount" name="classroomCount" min="0" placeholder="Times">
            </div>
             
            <div>
                <input type="checkbox" id="talk" name="event" value="talk">
                <label for="talk">Talk to V=UAT</label>
                <input type="number" id="talkCount" name="talkCount" min="0" placeholder="Times">
            </div>

            <br>
            <label for="betAmount">Stake Amount:</label>
            <input type="number" id="betAmount" name="betAmount" min="1" placeholder="Enter stake amount">

            <p>Odds:</p>
            <ul>
                <li>Turning off the monitors: 9/8</li>
                <li>Threatening to be kicked out of the classroom: 3/2</li>
                <li>Talk to AT: 100/99</li>
            </ul>

            <br>
            <input type="submit" value="Place Bet">
            <p id="totalWinnings">Total Potential Winnings: $0.00</p>
        </fieldset>
        <!-- Add a div to display the bet summary -->
<div id="betSummary" style="display:none;">
    <h2>Bet Summary</h2>
    <p id="selectedBets"></p>
    <p>Overall Odds: <span id="overallOdds">0</span></p>
    <p>Potential Winnings: <span id="displayWinnings">0</span></p>
    <p>Stake Amount: <span id="displayStake">0</span></p>
</div>

    </form>

    <script>
      // Array to keep track of all bets placed
let betsPlaced = [];

// Function to display all bets placed
function displayBetsPlaced() {
    const betsContainer = document.getElementById('betsPlaced');
    betsContainer.innerHTML = ''; // Clear the previous list
    betsPlaced.forEach((bet, index) => {
        const betElement = document.createElement('p');
        betElement.textContent = `Bet ${index + 1}: ${bet.description} - Stake: $${bet.stake} - Potential Winnings: $${bet.potentialWinnings}`;
        betsContainer.appendChild(betElement);
    });
}

// Function to update the bet summary
function updateBetSummary() {
    const whiteboardCount = parseInt(document.getElementById("whiteboardCount").value) || 0;
    const classroomCount = parseInt(document.getElementById("classroomCount").value) || 0;
    const talkCount = parseInt(document.getElementById("talkCount").value) || 0;
    const betAmount = parseFloat(document.getElementById("betAmount").value) || 0;

    const whiteboardOdds = 9 / 8;
    const classroomOdds = 3 / 2;
    const talkOdds = 100 / 99;

    const combinedOdds = calculateCombinedOdds(whiteboardOdds, whiteboardCount, classroomOdds, classroomCount, talkOdds, talkCount);
    const potentialWinnings = betAmount * combinedOdds;

    // Update the bet summary display
    document.getElementById("selectedBets").textContent = `Selected Bets: ${formatSelectedBets(whiteboardCount, classroomCount, talkCount)}`;
    document.getElementById("overallOdds").textContent = `Overall Odds: ${combinedOdds.toFixed(2)}`;
    document.getElementById("displayWinnings").textContent = `Potential Winnings: $${potentialWinnings.toFixed(2)}`;
    document.getElementById("displayStake").textContent = `Stake Amount: $${betAmount.toFixed(2)}`;
}

// Function to calculate combined odds
function calculateCombinedOdds(whiteboardOdds, whiteboardCount, classroomOdds, classroomCount, talkOdds, talkCount) {
    return adjustedOdds(whiteboardOdds, whiteboardCount) *
           adjustedOdds(classroomOdds, classroomCount) *
           adjustedOdds(talkOdds, talkCount);
}

// Function to format the selected bets for display
function formatSelectedBets(whiteboardCount, classroomCount, talkCount) {
    const bets = [];
    if (whiteboardCount > 0) bets.push(`Turning off the whiteboard x${whiteboardCount}`);
    if (classroomCount > 0) bets.push(`Threatening to be kicked out of the classroom x${classroomCount}`);
    if (talkCount > 0) bets.push(`Talk to V=UAT x${talkCount}`);
    return bets.join(', ');
}

// Function to adjust odds based on count
function adjustedOdds(odds, count) {
    return Math.pow(odds, count);
}

// Counter for the number of bets placed
let betCount = 0;

// Add event listener to the form's submit event
document.querySelector('form').addEventListener('submit', function(event) {
    event.preventDefault(); // Prevent the default form submission

    const whiteboardCount = parseInt(document.getElementById("whiteboardCount").value) || 0;
    const classroomCount = parseInt(document.getElementById("classroomCount").value) || 0;
    const talkCount = parseInt(document.getElementById("talkCount").value) || 0;
    const betAmount = parseFloat(document.getElementById('betAmount').value) || 0;

    // Increment the bet count and check if the maximum number of bets is reached
    betCount++;
    if (betCount > 5) {
        alert('You have reached the maximum number of bets allowed.');
        betCount--; // Decrement the bet count as this bet is not placed
        return;
    }

    // Place the bet and update the bet summary
    placeBet(betAmount, whiteboardCount, classroomCount, talkCount);
});

// Function to place a bet and update the user's balance
async function placeBet(betAmount, whiteboardCount, classroomCount, talkCount) {
    console.log('Attempting to place a bet...'); // Log attempt to place a bet

    const userId = auth.currentUser ? auth.currentUser.uid : null; // Get the current user's ID
    console.log('Current User ID:', userId); // Log the current user's ID

    if (!userId) {
        console.error('No user logged in. Cannot place a bet.');
        return;
    }

    // Reference to the user's document
    const userRef = doc(db, 'users', userId);
    console.log('User document reference:', userRef); // Log the user document reference

    try {
        console.log('Starting transaction...'); // Log the start of the transaction
        await runTransaction(db, async (transaction) => {
            console.log('Inside transaction...'); // Log inside the transaction

            const userDoc = await transaction.get(userRef);
            console.log('Retrieved user document:', userDoc.exists()); // Log if the user document exists

            if (!userDoc.exists()) {
                throw new Error("User does not exist!");
            }

            const userData = userDoc.data();
            console.log('Current balance:', userData.balance); // Log the current balance

            if (userData.balance < betAmount) {
                throw new Error("Insufficient funds!");
            }

            // Deduct the bet amount from the user's balance
            const newBalance = userData.balance - betAmount;
            console.log('New balance after bet:', newBalance); // Log the new balance

            // Update the user's balance in the transaction
            transaction.update(userRef, { balance: newBalance });
            console.log('Updated user balance in transaction.'); // Log the balance update

            // After placing the bet, add it to the betsPlaced array
            const betDescription = formatSelectedBets(whiteboardCount, classroomCount, talkCount);
            const whiteboardOdds = 9 / 8;
            const classroomOdds = 3 / 2;
            const talkOdds = 100 / 99;
            const combinedOdds = calculateCombinedOdds(whiteboardOdds, whiteboardCount, classroomOdds, classroomCount, talkOdds, talkCount);
            const potentialWinnings = betAmount * combinedOdds;

            betsPlaced.push({
                description: betDescription,
                stake: betAmount,
                potentialWinnings: potentialWinnings.toFixed(2)
            });

            // Update the display of bets placed
            displayBetsPlaced();
        });
        console.log('Transaction completed successfully.'); // Log the successful completion of the transaction
    } catch (error) {
        console.error('Failed to place bet:', error); // Log any errors encountered
        betCount--; // Decrement the bet count if the bet was not successfully placed
    }
}


    // After placing the bet, add it to the betsPlaced array
    const betDescription = formatSelectedBets(whiteboardCount, classroomCount, talkCount);
    const combinedOdds = calculateCombinedOdds(whiteboardOdds, whiteboardCount, classroomOdds, classroomCount, talkOdds, talkCount);
    const potentialWinnings = betAmount * combinedOdds;

    betsPlaced.push({
        description: betDescription,
        stake: betAmount,
        potentialWinnings: potentialWinnings.toFixed(2)
    });

    // Update the display of bets placed
    displayBetsPlaced();
}

// Event listeners for calculating winnings
document.getElementById("whiteboardCount").addEventListener("input", updateBetSummary);
document.getElementById("classroomCount").addEventListener("input", updateBetSummary);
document.getElementById("talkCount").addEventListener("input", updateBetSummary);
document.getElementById("betAmount").addEventListener("input", updateBetSummary);


      </script>
  
      <script type="module">
            
              // Import the functions you need from the SDKs you need
              // Import the functions you need from the SDKs you need
// Import the functions you need from the SDKs you need
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-app.js";
import { getFirestore, doc, setDoc, getDoc, runTransaction } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-firestore.js";
import { getAuth, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-auth.js";
          import { onSnapshot } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-firestore.js";


          
// The runTransaction function is part of Firestore and does not need to be imported separately

// Your web app's Firebase configuration
const firebaseConfig = {
  apiKey: "AIzaSyASccDZI88CsOteCtjaeIgR3XNYiotV01I",
  authDomain: "gamblingproject-531a2.firebaseapp.com",
  projectId: "gamblingproject-531a2",
  storageBucket: "gamblingproject-531a2.appspot.com",
  messagingSenderId: "979010319245",
  appId: "1:979010319245:web:c79d1d04abe721b5df03c4",
  measurementId: "G-Q26C1LE2Q7"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);


       // Function to place a bet and update the user's balance
async function placeBet(betAmount) {
    console.log('Attempting to place a bet...'); // Log attempt to place a bet

    const userId = auth.currentUser ? auth.currentUser.uid : null; // Get the current user's ID
    console.log('Current User ID:', userId); // Log the current user's ID

    if (!userId) {
        console.error('No user logged in. Cannot place a bet.');
        return;
    }

    // Reference to the user's document
    const userRef = doc(db, 'users', userId);
    console.log('User document reference:', userRef); // Log the user document reference

    try {
        console.log('Starting transaction...'); // Log the start of the transaction
        await runTransaction(db, async (transaction) => {
            console.log('Inside transaction...'); // Log inside the transaction

            const userDoc = await transaction.get(userRef);
            console.log('Retrieved user document:', userDoc.exists()); // Log if the user document exists

            if (!userDoc.exists()) {
                throw new Error("User does not exist!");
            }

            const userData = userDoc.data();
            console.log('Current balance:', userData.balance); // Log the current balance

            if (userData.balance < betAmount) {
                throw new Error("Insufficient funds!");
            }

            // Deduct the bet amount from the user's balance
            const newBalance = userData.balance - betAmount;
            console.log('New balance after bet:', newBalance); // Log the new balance

            // Update the user's balance in the transaction
            transaction.update(userRef, { balance: newBalance });
            console.log('Updated user balance in transaction.'); // Log the balance update
        });
        console.log('Transaction completed successfully.'); // Log the successful completion of the transaction
    } catch (error) {
        console.error('Failed to place bet:', error); // Log any errors encountered
    }
}
          auth.onAuthStateChanged((user) => {
  if (user) {
    // User is signed in, call the function to display and update the balance
    displayAndUpdateBalance();
  } else {
    // User is signed out, handle it appropriately
    console.log('User is not logged in.');
  }
});


          
          function displayAndUpdateBalance() {
  const user = auth.currentUser;
  if (user) {
    const userRef = doc(db, 'users', user.uid);
    
    // Listen for real-time updates to the user's document
    onSnapshot(userRef, (doc) => {
      const userData = doc.data();
      if (userData && userData.balance !== undefined) {
        // Update the balance displayed in the <span> element
        document.getElementById('balance').textContent = `$${userData.balance.toFixed(2)}`;
      }
    }, (error) => {
      // Handle any errors that occur
      console.error("Error fetching user data:", error);
    });
  }
}



        // Add this function call to your form's submit event
        document.querySelector('form').addEventListener('submit', function(event) {
            event.preventDefault(); // Prevent the default form submission
            const betAmount = parseFloat(document.getElementById('betAmount').value) || 0;
            placeBet(betAmount);
        });
     </script>
</head>
<body>
      </html>
<body>
      </html>
